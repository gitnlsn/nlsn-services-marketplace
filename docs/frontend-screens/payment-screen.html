<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./styles.css">
    <title>Payment Screen - Frontend</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; margin: 0; background-color: #f5f7fa; color: #333; }
        .container { max-width: 1000px; margin: 40px auto; background: #fff; padding: 40px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.07); }
        .back-link { display: inline-flex; align-items: center; gap: 8px; color: #0056b3; text-decoration: none; margin-bottom: 24px; font-size: 14px; transition: all 0.2s; }
        .back-link:hover { gap: 12px; color: #004494; }
        h1 { color: #0056b3; margin-bottom: 8px; font-size: 32px; }
        h2 { color: #2c3e50; margin-top: 32px; margin-bottom: 16px; font-size: 24px; }
        h3 { color: #34495e; margin-top: 24px; margin-bottom: 12px; font-size: 18px; }
        
        .description { background: linear-gradient(135deg, #f8f9fa 0%, #e7f3ff 100%); padding: 24px; border-radius: 12px; margin: 24px 0; border-left: 4px solid #0056b3; }
        .description p { margin: 8px 0; }
        .description strong { color: #0056b3; }
        
        .section-card { background: #fff; border: 1px solid #e1e8ed; border-radius: 12px; padding: 24px; margin: 20px 0; transition: all 0.3s; }
        .section-card:hover { box-shadow: 0 6px 12px rgba(0,0,0,0.08); transform: translateY(-2px); }
        
        .ui-elements { background: #e7f3ff; }
        .api-calls { background: #fff3cd; }
        .security-features { background: #d4edda; }
        .error-handling { background: #f8d7da; }
        
        pre.mermaid { background: #f8f9fa; border: 2px solid #dee2e6; padding: 24px; border-radius: 12px; overflow-x: auto; margin: 24px 0; }
        
        ul { padding-left: 24px; }
        li { margin: 8px 0; }
        li strong { color: #2c3e50; }
        
        code { background: #f8f9fa; padding: 2px 6px; border-radius: 4px; font-family: 'Monaco', 'Consolas', monospace; font-size: 14px; color: #d73a49; }
        
        .payment-methods { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin: 16px 0; }
        .payment-method { background: #f8f9fa; padding: 16px; border-radius: 8px; border: 2px solid #dee2e6; text-align: center; }
        .payment-method h4 { margin: 0 0 8px 0; color: #0056b3; }
        .payment-method p { margin: 0; font-size: 14px; color: #666; }
        
        .badge { display: inline-block; padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 600; margin: 0 4px; }
        .badge-primary { background: #e7f3ff; color: #0056b3; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-warning { background: #fff3cd; color: #856404; }
        
        .responsive-section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 16px 0; }
        .responsive-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">‚Üê Back to Frontend Screens</a>
        
        <h1>Payment Screen</h1>
        
        <div class="description">
            <h2>Description</h2>
            <p>The Payment Screen facilitates secure payment processing through Pagarme's hosted checkout solution. Instead of collecting payment details directly, the platform redirects users to Pagarme's secure checkout page, ensuring PCI compliance and supporting multiple Brazilian payment methods.</p>
            <p><strong>Primary Purpose:</strong> Generate and redirect users to Pagarme checkout links for secure payment processing, while maintaining order context and providing clear feedback throughout the payment journey.</p>
        </div>

        <div class="section-card ui-elements">
            <h2>UI Elements</h2>
            
            <h3>Pre-Payment Summary</h3>
            <ul>
                <li><strong>Order Summary Card:</strong> Service details, professional name, date/time</li>
                <li><strong>Price Breakdown:</strong>
                    <ul>
                        <li>Service base price</li>
                        <li>Platform fee (displayed transparently)</li>
                        <li>Total amount in BRL</li>
                    </ul>
                </li>
                <li><strong>Promo Code Field:</strong> Optional discount code with apply button</li>
                <li><strong>Terms Checkbox:</strong> "I agree to the terms of service and cancellation policy"</li>
                <li><strong>Proceed to Payment Button:</strong> Large, prominent CTA that generates checkout link</li>
            </ul>

            <h3>Payment Redirect Experience</h3>
            <ul>
                <li><strong>Loading State:</strong> "Generating secure payment link..." with spinner</li>
                <li><strong>Redirect Notice:</strong> "You will be redirected to Pagarme's secure checkout"</li>
                <li><strong>Security Badge:</strong> "üîí Secure payment powered by Pagarme"</li>
                <li><strong>Manual Redirect Link:</strong> "Click here if you're not redirected automatically"</li>
                <li><strong>Cancel Button:</strong> Return to booking without payment</li>
            </ul>

            <h3>Available Payment Methods (via Pagarme Checkout)</h3>
            <div class="payment-methods">
                <div class="payment-method">
                    <h4>üí≥ Credit/Debit Cards</h4>
                    <p>All major brands accepted</p>
                </div>
                <div class="payment-method">
                    <h4>üì± Pix</h4>
                    <p>Instant payment via QR code</p>
                </div>
                <div class="payment-method">
                    <h4>üìÑ Boleto</h4>
                    <p>Bank slip for cash payment</p>
                </div>
            </div>

            <h3>Return from Payment</h3>
            <ul>
                <li><strong>Processing Animation:</strong> "Verifying payment status..." with spinner</li>
                <li><strong>Success State:</strong>
                    <ul>
                        <li>Green checkmark animation</li>
                        <li>"Payment confirmed! Your booking is complete."</li>
                        <li>Booking reference number</li>
                        <li>"View Booking" button</li>
                    </ul>
                </li>
                <li><strong>Pending State:</strong>
                    <ul>
                        <li>Yellow clock icon</li>
                        <li>"Payment is being processed"</li>
                        <li>"We'll notify you once confirmed"</li>
                        <li>Expected confirmation time</li>
                    </ul>
                </li>
                <li><strong>Failed State:</strong>
                    <ul>
                        <li>Red X icon</li>
                        <li>"Payment was not completed"</li>
                        <li>"Try Again" button</li>
                        <li>"Contact Support" link</li>
                    </ul>
                </li>
            </ul>

            <h3>Important Notice</h3>
            <div style="background: #fff3cd; border: 1px solid #856404; border-radius: 8px; padding: 16px; margin: 20px 0;">
                <strong>‚ö†Ô∏è No Payment Data Collection</strong>
                <p>This platform does not collect or store any payment information. All sensitive payment data (credit card numbers, CVV, etc.) is handled exclusively by Pagarme's PCI-compliant infrastructure.</p>
            </div>
        </div>

        <div class="section-card api-calls">
            <h2>API Calls</h2>
            <ul>
                <li><code>booking.initializePayment(bookingId)</code> - Start payment process for booking</li>
                <li><code>payment.createCheckoutLink({ bookingId, amount, customer, items })</code> - Generate Pagarme checkout URL</li>
                <li><code>promos.validate(promoCode, bookingId)</code> - Validate and apply promotional discount</li>
                <li><code>payment.getCheckoutStatus(checkoutId)</code> - Check payment status after redirect</li>
                <li><code>booking.confirmPayment(bookingId, paymentId)</code> - Update booking with payment confirmation</li>
                <li><code>notifications.sendPaymentConfirmation(bookingId)</code> - Send confirmation to both parties</li>
                <li><code>payment.handleWebhook(webhookData)</code> - Process Pagarme webhook notifications</li>
            </ul>
        </div>

        <h2>User Interaction Flow</h2>
        <pre class="mermaid">
flowchart TD
    A[User Confirms Booking] --> B[Load Payment Summary]
    B --> C[Display Order Details]
    C --> D{Apply Promo Code?}
    D -->|Yes| E[Validate Promo]
    E --> F[Update Pricing]
    D -->|No| G[Accept Terms]
    F --> G
    
    G --> H[Click Proceed to Payment]
    H --> I[Call Backend API]
    I --> J[Generate Checkout Link]
    J --> K[Return Checkout URL]
    K --> L[Show Redirect Screen]
    L --> M[Redirect to Pagarme]
    
    M --> N[User on Pagarme Checkout]
    N --> O{Select Payment Method}
    
    O -->|Credit Card| P[Enter Card Details]
    O -->|Pix| Q[Show QR Code]
    O -->|Boleto| R[Generate Boleto]
    
    P --> S{Complete Payment}
    Q --> S
    R --> T[Show Boleto Info]
    
    S -->|Success| U[Payment Confirmed]
    S -->|Cancel| V[User Cancelled]
    S -->|Fail| W[Payment Failed]
    
    U --> X[Redirect to Success URL]
    V --> Y[Redirect to Cancel URL]
    W --> Y
    
    X --> Z[Verify Payment Status]
    Z --> AA{Status Check}
    AA -->|Confirmed| AB[Show Success]
    AA -->|Pending| AC[Show Pending]
    AA -->|Failed| AD[Show Error]
    
    Y --> AE[Return to Booking]
    AE --> AF[Show Retry Option]
    
    AB --> AG[Navigate to Booking Details]
    AC --> AH[Enable Status Tracking]
    AD --> AF
    
    T --> AI[Pending Payment]
    AI --> AH
    
    style A fill:#ADD8E6,stroke:#333,stroke-width:2px
    style D fill:#FFD700,stroke:#333,stroke-width:2px
    style O fill:#FFD700,stroke:#333,stroke-width:2px
    style S fill:#FFD700,stroke:#333,stroke-width:2px
    style AA fill:#FFD700,stroke:#333,stroke-width:2px
    style U fill:#C8E6C9,stroke:#333,stroke-width:2px
    style AB fill:#C8E6C9,stroke:#333,stroke-width:2px
    style V fill:#FFCDD2,stroke:#333,stroke-width:2px
    style W fill:#FFCDD2,stroke:#333,stroke-width:2px
    style AD fill:#FFCDD2,stroke:#333,stroke-width:2px
</pre>

        <div class="section-card security-features">
            <h2>Security Features</h2>
            <ul>
                <li><strong>No Payment Data Handling:</strong> All sensitive payment data handled exclusively by Pagarme</li>
                <li><strong>Secure Checkout Links:</strong> Unique, time-limited URLs generated for each transaction</li>
                <li><strong>Webhook Validation:</strong> Cryptographic signature verification for all payment notifications</li>
                <li><strong>Session Security:</strong> Payment sessions linked to authenticated users only</li>
                <li><strong>HTTPS Enforcement:</strong> All API communications encrypted with TLS</li>
                <li><strong>Idempotency Keys:</strong> Prevent duplicate payment processing</li>
                <li><strong>PCI DSS Compliance:</strong> Fully compliant through Pagarme's hosted solution</li>
            </ul>
        </div>

        <h2>Pagarme Integration Details</h2>
        <div class="section-card">
            <h3>Checkout Link Configuration</h3>
            <ul>
                <li><strong>Success URL:</strong> <code>https://platform.com/bookings/{bookingId}/payment-success</code></li>
                <li><strong>Cancel URL:</strong> <code>https://platform.com/bookings/{bookingId}/payment-cancelled</code></li>
                <li><strong>Webhook URL:</strong> <code>https://platform.com/api/webhooks/pagarme</code></li>
                <li><strong>Payment Methods:</strong> All enabled (credit_card, pix, boleto)</li>
                <li><strong>Link Expiration:</strong> 24 hours from creation</li>
                <li><strong>Customer Data:</strong> Pre-filled from authenticated user profile</li>
                <li><strong>Metadata:</strong> Booking ID, user ID, service details included</li>
            </ul>

            <h3>Webhook Events Handled</h3>
            <ul>
                <li><code>order.paid</code> - Payment successfully completed</li>
                <li><code>order.payment_failed</code> - Payment attempt failed</li>
                <li><code>order.canceled</code> - Order cancelled by user</li>
                <li><code>order.closed</code> - Order expired or closed</li>
                <li><code>charge.paid</code> - Individual charge paid (for installments)</li>
                <li><code>pix.paid</code> - Pix payment confirmed</li>
                <li><code>boleto.paid</code> - Boleto payment confirmed</li>
            </ul>
        </div>

        <div class="section-card error-handling">
            <h2>Error Handling</h2>
            <div class="responsive-grid">
                <div>
                    <h3>Pre-Payment Errors</h3>
                    <ul>
                        <li><span class="badge badge-danger">Invalid Booking</span> - Redirect to bookings list</li>
                        <li><span class="badge badge-warning">Expired Booking</span> - Show expiration message</li>
                        <li><span class="badge badge-warning">Already Paid</span> - Redirect to booking details</li>
                        <li><span class="badge badge-danger">Invalid Promo Code</span> - Clear error message</li>
                    </ul>
                </div>
                <div>
                    <h3>Integration Errors</h3>
                    <ul>
                        <li><span class="badge badge-danger">Checkout Link Failed</span> - Retry with exponential backoff</li>
                        <li><span class="badge badge-warning">Redirect Failed</span> - Show manual checkout link</li>
                        <li><span class="badge badge-danger">Webhook Timeout</span> - Fallback to manual status check</li>
                        <li><span class="badge badge-warning">Network Error</span> - Queue for retry when online</li>
                    </ul>
                </div>
            </div>
        </div>

        <h2>State Management</h2>
        <ul>
            <li><strong>Booking State:</strong> Current booking details, pricing with any discounts applied</li>
            <li><strong>Payment State:</strong> Checkout URL, payment session ID, redirect status</li>
            <li><strong>UI State:</strong> Loading states, error messages, redirect countdown timer</li>
            <li><strong>Return State:</strong> Payment result from Pagarme, verification status</li>
            <li><strong>Promo State:</strong> Applied promo code, discount amount, validation status</li>
        </ul>

        <h2>Performance Optimizations</h2>
        <ul>
            <li><strong>Prefetch Booking Data:</strong> Load booking details before payment screen renders</li>
            <li><strong>Quick Redirect:</strong> Minimize time spent on redirect screen (< 2 seconds)</li>
            <li><strong>Webhook Priority Queue:</strong> Process payment webhooks with highest priority</li>
            <li><strong>Status Caching:</strong> Cache payment status for quick return visits</li>
            <li><strong>Fallback Polling:</strong> Check payment status if webhook is delayed</li>
            <li><strong>Progressive Enhancement:</strong> Show manual link if auto-redirect fails</li>
        </ul>

        <div class="responsive-section">
            <h2>Responsive Design</h2>
            <div class="responsive-grid">
                <div>
                    <h3>üì± Mobile</h3>
                    <ul>
                        <li>Single column layout</li>
                        <li>Bottom sheet for payment methods</li>
                        <li>Native keyboard for card input</li>
                        <li>Large touch targets</li>
                        <li>Sticky pay button</li>
                    </ul>
                </div>
                <div>
                    <h3>üì± Tablet</h3>
                    <ul>
                        <li>Two-column layout</li>
                        <li>Side-by-side form and summary</li>
                        <li>Modal payment forms</li>
                        <li>Optimized QR code size</li>
                    </ul>
                </div>
                <div>
                    <h3>üíª Desktop</h3>
                    <ul>
                        <li>Three-column layout</li>
                        <li>Sticky order summary</li>
                        <li>Inline validation messages</li>
                        <li>Keyboard shortcuts</li>
                        <li>Hover states</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>
</body>
</html>