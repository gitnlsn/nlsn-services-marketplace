<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Architecture Diagrams</title>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>
</head>
<body>
    <h1>System Architecture Diagrams</h1>

    <p>For a detailed explanation of these diagrams, please refer to the main <a href="./index.html">documentation</a>.</p>

    <h2>High-Level Overview</h2>
    <pre class="mermaid">
        graph TD
            A[User] -->|Interacts with| B(React Frontend);
            B -->|tRPC API Calls| C(Next.js API Routes);
            C -->|Database Queries| D(Prisma ORM);
            D --> E(PostgreSQL Database with pgvector);
            C -->|Payment Processing| F(Pagarme API);
            C -->|File Uploads| G(Cloud Storage);
            C -->|Embedding Generation| H(Embedding Model);
            C -->|Notifications| I(Twilio API);
    </pre>

    <h2>User Use Cases</h2>
    <pre class="mermaid">
        graph TD
            subgraph "User"
                U[ ]
            end

            subgraph "System"
                UC1(Manage Profile)
                UC2(Search for Services)
                UC3(View Service/Portfolio)
                UC4(Book a Service)
                UC5(Pay for Service)
                UC7(Leave a Review)
                UC8(Create/Edit Service Listing)
                UC9(Upload Photos/Videos)
                UC10(Manage Bookings)
                UC11(View Earnings & Request Withdrawal)
                UC12(Manage Notification Preferences)
            end

            U -- manages --> UC1
            U -- can --> UC2
            UC2 --> UC3
            UC3 --> UC4
            UC4 --> UC5
            UC5 --> UC7
            U -- can --> UC8
            UC8 -- includes --> UC9
            U -- can --> UC10
            U -- can --> UC11
            U -- manages --> UC12
    </pre>

    <h2>Service Discovery (Semantic Search)</h2>
    <pre class="mermaid">
        sequenceDiagram
            participant User
            participant Frontend
            participant Backend
            participant EmbeddingModel
            participant Database

            User->>Frontend: Enters search query (e.g., "logo design for my new coffee shop")
            Frontend->>Backend: Sends search query
            Backend->>EmbeddingModel: Generates embedding for the query
            EmbeddingModel-->>Backend: Returns query embedding
            Backend->>Database: Performs vector similarity search for services
            Database-->>Backend: Returns ranked list of matching services
            Backend-->>Frontend: Sends service results
            Frontend-->>User: Displays relevant services
    </pre>

    <h2>Service Booking and Payment Flow</h2>
    <pre class="mermaid">
        sequenceDiagram
            participant "User (as Client)"
            participant "User (as Professional)"
            participant Frontend
            participant Backend
            participant Pagarme
            participant Twilio

            "User (as Client)"->>Frontend: Selects a service to book
            Frontend->>Backend: POST /api/bookings (serviceId)
            Backend->>Pagarme: Create Charge
            Pagarme-->>Backend: Returns payment details
            Backend-->>Frontend: Displays payment instructions
            "User (as Client)"->>Pagarme: Completes payment
            Pagarme->>Backend: Webhook notification (payment success)
            Backend->>Backend: Update booking status to "Paid", credit professional's account balance
            Backend->>Twilio: Send booking confirmation to Client
            Backend->>Twilio: Send new booking alert to Professional
            Backend->>Frontend: Notify client of success
            "User (as Professional)"->>Backend: Notifies service complete
            "User (as Client)"->>Backend: (Optional) Notifies service complete
            Backend->>Backend: Funds held for 15 days
            Backend->>"User (as Professional)": Funds available for withdrawal after 15 days
    </pre>

    <h2>Withdrawal Flow</h2>
    <pre class="mermaid">
        sequenceDiagram
            participant "User (as Professional)"
            participant Frontend
            participant Backend
            participant Pagarme
            participant Twilio

            "User (as Professional)"->>Frontend: Requests withdrawal
            Frontend->>Backend: POST /api/withdrawals (amount)
            Backend->>Backend: Verify user balance and process request
            Backend->>Pagarme: Initiate Transfer to user's bank account
            Pagarme-->>Backend: Confirmation of transfer
            Backend->>Backend: Update user's balance
            Backend->>Twilio: Send withdrawal confirmation to Professional
            Backend-->>Frontend: Notify user of successful withdrawal
    </pre>

</body>
</html>